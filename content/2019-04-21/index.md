---
title: "Elixir 시작"
date: "2019-04-21"
category: "tech"
cover: https://elixir-lang.org/
tags:
    - elixir
---

최근 Elixir 공부를 시작했다.

## 시작하게 된 배경

회사에서 Figma의 유려한 실시간 협업 기능을 체험해본 뒤에, 실시간 협업 기능을 잘 구현해보고 싶어져서 관련 기술 리서치를 시작했다.

실시간 협업의 대명사는 역시 온라인 게임 서버. 온라인 게임 서버를 구현할 때 쓰이는 부동의 1위 언어는 C++. TCP 소켓을 통해 직접 만든 바이너리 프로토콜을 가지고 통신을 하는 것이 일반적인 것 같다.
하지만 C++을 당장 하기는 어려울 것 같고, 웹에서의 실시간 협업 기능을 구현해보고 싶은 거라 일단은 제외. 다만 여러가지 설계 기법들은 참고할 수 있을 듯하다.

온라인 게임 서버 관련 리서치를 하다 보니, 대개 클라이언트와 서버의 상태 변화 로직이 유사해서, 클라이언트 측과 서버 측에서 같은 코드를 사용할 수 있다면 구조가 드라마틱하게 단순해질 수 있다는 이야기를 발견했다. 그래서 Node.js 도 고민해보기 시작.

Node.js 에서 stateful 웹 서버를 만들 수 있을지 알아봤는데, 이런 식으로 사용하는 사례를 찾지 못했다. Node.js 자체가 원래부터 크래시 문제에 많이 시달려서 (프로세스가 아무 일도 없는데 그냥 죽어버리는 등) process manager 생태계까지 존재하는데 아직 크게 나아지지 않은 모양이다. 그렇다고 stateless (모든 상태를 Redis 같은 외부 저장소에 저장하는 방식)으로 구현하게 되면, 아주 빠르게 변해야 하는(실시간!) 상태를 외부 저장소에 저장한다는 것은 네트워크 비용 / 직렬화, 역직렬화로 인한 레이턴시가 생길 것 같으므로 비현실적이라 생각했다.

(Node.js 생태계에 액터 프레임워크 같은게 있나 찾아보다가 [Moleculer](https://moleculer.services/) 라는걸 발견했는데, 이건 액터를 다루는 것은 아니고 미리 정의된 워커를 여러 개 띄울 수 있는 프레임워크. Node.js 가지고 큰 서비스 만들어야 할 때 써볼만해 보인다.)
 
여기까지 조사해보고 든 생각은 '역시 액터인가?'

액터 하면 역시 유명한 두 기술 - Akka, Erlang - 중 하나를 택해야 할텐데, JVM은 왠지 싫어서 그냥 Erlang을 선택. Erlang은 문법이 좀 괴랄한 편인 관계로 예전에 잠깐 봐두었던 Elixir라는 언어를 다시 만져보기로 함.

## Elixir?

- Elixir는 Erlang VM(BEAM)에서 동작하는 언어
- 문법은 Ruby와 비슷
- 함수형 패러다임의 여러 요소들을 잘 지원 (패턴 매칭, 꼬리 재귀, 모든 값은 불변 등등)
- 서버 측 코드 핫 리로딩이 가능하다 (!)
- 객체 대신 액터라는 걸 사용한다.

## 액터(Actor)?

액터(경량 프로세스)는 다른 언어에서의 객체처럼 사용되는 느낌인데, 객체와의 차이점은 동시성 처리의 단위이기도 하다는 것.

### 객체

- 여러 객체 간에 상태를 공유하는 게 가능하다. (같은 객체에 대한 참조를 가지고 있는 등)
- 객체 간에는 메소드 호출을 통해 정보를 공유한다. 이 때 메소드 호출은 대개 동기적으로 이루어진다.
- 여러 개의 스레드가 동시에 하나의 객체에 접근하는게 가능하다.

=> 즉, 경쟁상태가 발생할 수 있어서 손수 경쟁상태를 해소해주어야 한다.

### 액터

- 서로 다른 액터 간에는 아무런 상태도 공유하지 않는다.
- 액터 간에는 메시지 전달을 통해 정보를 공유한다. 이 때 메시지 전달은 항상 비동기적으로 이루어진다. 다른 액터가 보낸 메시지는 액터 내부의 큐에 쌓이고 순서대로 처리된다.
- 메시지 처리는 한 번에 하나의 스레드를 통해 이루어짐.

=> 경쟁상태를 일으킬 수 있는 요인이 제거됨. => 동시성에 대해 사람이 신경 쓸 필요가 없어짐